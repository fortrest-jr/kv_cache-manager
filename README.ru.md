# KV Cache Manager для SillyTavern

**Русская версия** | [English](README.md)

Расширение для управления KV-кешем llama.cpp сервера с автоматическим сохранением и загрузкой кеша. Поддерживает как одиночные, так и групповые чаты с несколькими персонажами.

## Установка

Через меню расширений SillyTavern.

### Ручная установка

1. Скопируйте папку `kv-cache-manager` в `public/scripts/extensions/` вашей установки SillyTavern
2. Перезагрузите страницу SillyTavern
3. Расширение появится в настройках на вкладке "KV Cache Manager"

### Серверный плагин

Для работы функции загрузки файлов необходимо установить серверный плагин:

**Серверный плагин KV Cache Manager**: [https://github.com/fortrest-jr/kv_cache-manager-plugin](https://github.com/fortrest-jr/kv_cache-manager-plugin)

Плагин предоставляет API для получения списка файлов сохранений и их удаления. Без установки плагина функция загрузки кеша будет недоступна.

## Сценарии использования

### Сценарий 1: Обычный чат с одним персонажем

1. **Начало работы**: Откройте чат с персонажем и начните генерацию ответа
   - Расширение автоматически выделит слот для персонажа
   - При первой генерации кеш будет пустым

2. **Автоматическое сохранение**: После каждых N сообщений (по умолчанию 5) кеш автоматически сохраняется
   - Индикатор в заголовке расширения показывает количество сообщений до следующего сохранения
   - Старые автосохранения автоматически удаляются при превышении лимита

3. **Автоматическая загрузка**: При следующей генерации ответа последний сохраненный кеш автоматически загружается
   - Уведомление показывает дату/время загруженного кеша

4. **Ручное сохранение важных моментов**: 
   - Нажмите "Сохранить с именем" и введите тег (например, "важный_момент")
   - Кеш будет сохранен с тегом и не будет удален при ротации автосохранений

### Сценарий 2: Групповой чат с несколькими персонажами

1. **Распределение по слотам**: При генерации ответов разных персонажей они автоматически распределяются по доступным слотам
   - Каждый персонаж получает свой слот
   - Счетчик использования отслеживается для каждого слота отдельно

2. **Вытеснение слотов**: Если слотов меньше, чем персонажей:
   - Персонаж с наименьшим использованием вытесняется
   - Перед вытеснением кеш автоматически сохраняется (если использовался минимум 1 раз)
   - Новый персонаж занимает освобожденный слот

3. **Независимое автосохранение**: Каждый персонаж имеет свой счетчик сообщений
   - Кеш сохраняется независимо для каждого персонажа
   - Ротация файлов происходит отдельно для каждого персонажа

4. **Сохранение отдельных слотов**: 
   - В интерфейсе управления слотами есть кнопка сохранения для каждого слота
   - Позволяет сохранить кеш конкретного персонажа без сохранения остальных

### Сценарий 3: Переключение между чатами

1. **Автоматическое сохранение**: При переключении на другой чат:
   - Кеш всех персонажей текущего чата автоматически сохраняется (если использовался минимум 1 раз)
   - Все слоты очищаются на сервере

2. **Распределение нового чата**: Персонажи нового чата автоматически распределяются по слотам
   - Для групповых чатов все участники распределяются по доступным слотам
   - Для обычных чатов один персонаж занимает первый слот

3. **Автозагрузка при генерации**: При первой генерации в новом чате:
   - Автоматически загружается последний сохраненный кеш для каждого персонажа из этого чата
   - Если кеша нет, генерация продолжается с пустым кешем

### Сценарий 4: Ручная загрузка сохранений

1. **Открытие popup загрузки**: Нажмите кнопку "Загрузить кеш"

2. **Выбор чата**: 
   - Текущий чат отображается первым с пометкой "[текущий]"
   - Можно выбрать любой другой чат из списка
   - Поиск по имени чата для быстрого доступа

3. **Выбор персонажей**:
   - Внутри выбранного чата отображаются все персонажи с сохранениями
   - Каждый персонаж может иметь несколько сохранений (разверните группу)
   - Выберите нужное сохранение для каждого персонажа (клик по дате/времени)
   - Можно выбрать несколько персонажей одновременно

4. **Загрузка**:
   - Нажмите кнопку "Загрузить"
   - Кеши загружаются в соответствующие слоты
   - Если персонаж уже в слоте, кеш загружается в этот же слот
   - Если персонажа нет в слотах, для него выделяется новый слот

5. **Загрузка из другого чата**:
   - Можно загрузить кеш персонажа из другого чата
   - В уведомлении будет указано, из какого чата загружен кеш

### Сценарий 5: Предзагрузка кеша для групповых чатов

1. **Открытие popup предзагрузки**: 
   - Нажмите кнопку "Создать кеш для персонажей группы" (доступно только в групповых чатах)
   - Откроется popup со всеми персонажами группового чата

2. **Выбор персонажей**:
   - По умолчанию выбраны все не заглушенные персонажи
   - Можно выбрать/снять выбор персонажей с помощью чекбоксов
   - Заглушенные персонажи отображаются, но не выбраны по умолчанию
   - Используйте чекбокс "Выбрать все" для выбора/снятия выбора всех персонажей
   - Поиск по имени персонажа для быстрого доступа

3. **Процесс предзагрузки**:
   - Нажмите "Начать предзагрузку" для начала
   - Для каждого выбранного персонажа расширение:
     - Переключится на контекст этого персонажа
     - Сгенерирует тихий промпт (1 токен) для прогрева кеша
     - Автоматически сохранит кеш
   - Прогресс отображается в статусном сообщении с:
     - Текущим персонажем, который прогревается
     - Счетчиком прогресса (X/Всего)
     - Списком успешно прогретых персонажей
     - Списком ошибок (если есть)
   - Процесс можно отменить в любой момент

4. **Преимущества**:
   - Все персонажи имеют готовый кеш перед началом реальных разговоров
   - Более быстрые ответы во время взаимодействий в групповом чате
   - Автоматическое выделение слотов и управление кешем

### Сценарий 6: Управление сохранениями

1. **Ручное сохранение с тегом**: 
   - Нажмите "Сохранить с именем"
   - Введите тег (например, "конец_главы_1")
   - Кеш всех активных персонажей будет сохранен с этим тегом
   - Сохранения с тегами не удаляются при ротации автосохранений

2. **Мгновенное сохранение**: 
   - Нажмите "Сохранить сейчас"
   - Кеш сохранится без тега (как автосохранение)
   - Счетчики сообщений сбросятся для всех персонажей

3. **Освобождение слотов**: 
   - Нажмите "Очистить все слоты"
   - Все слоты будут очищены (кеш на сервере не удаляется)
   - Полезно для принудительного перераспределения персонажей

## Основные возможности

### Автоматическое сохранение
- **Интеллектуальное автосохранение**: Кеш автоматически сохраняется для каждого персонажа отдельно после каждых N сообщений (настраивается)
- **Индивидуальные счетчики**: Каждый персонаж имеет свой счетчик сообщений, что позволяет сохранять кеш независимо для разных персонажей
- **Визуальный индикатор**: Отображение количества сообщений до следующего автосохранения в заголовке расширения
- **Автоматическая ротация**: Старые автосохранения автоматически удаляются при превышении лимита (настраивается отдельно для каждого персонажа)

### Ручное сохранение
- **Сохранение с тегом**: Сохранение кеша для всех активных персонажей с указанным тегом (имя сохранения)
- **Мгновенное сохранение**: Сохранение без тега для всех активных персонажей (автосохранение по требованию)
- **Сохранение отдельных слотов**: Кнопка сохранения для каждого слота отдельно прямо из интерфейса управления слотами

### Автоматическая загрузка
- **Загрузка при генерации**: При начале генерации ответа персонажа автоматически загружается последний сохраненный кеш из текущего чата
- **Умное управление слотами**: Автоматическое распределение персонажей по слотам с вытеснением наименее используемых
- **Сохранение перед вытеснением**: Кеш персонажа автоматически сохраняется перед вытеснением из слота (если использовался минимум 1 раз)

### Предзагрузка для групповых чатов
- **Пакетное создание кеша**: Создание кеша для нескольких персонажей в групповых чатах одновременно
- **Тихая генерация**: Использует режим тихой генерации (1 токен) для прогрева кеша без видимых сообщений
- **Отслеживание прогресса**: Обновления статуса в реальном времени, показывающие текущего персонажа, прогресс и результаты
- **Отменяемо**: Можно отменить в любой момент во время процесса
- **Выборочная предзагрузка**: Выбор персонажей для предзагрузки (заглушенные персонажи исключены по умолчанию)
- **Автоматическое управление слотами**: Персонажи автоматически назначаются на слоты во время предзагрузки

### Ручная загрузка
- **Интерактивный popup**: Удобный интерфейс для выбора и загрузки сохранений
- **Группировка по чатам**: Сохранения организованы по чатам с возможностью выбора любого чата
- **Группировка по персонажам**: Внутри каждого чата сохранения сгруппированы по персонажам
- **Множественный выбор**: Возможность выбрать несколько персонажей для одновременной загрузки
- **Поиск**: Поиск по имени чата или персонажа
- **Информация о сохранениях**: Отображение даты/времени сохранения и тегов

### Управление слотами
- **Автоматическое распределение**: Персонажи автоматически распределяются по слотам при генерации
- **Отслеживание использования**: Счетчик использования каждого слота для оптимизации вытеснения
- **Визуальный интерфейс**: Отображение состояния всех слотов с информацией о персонажах и использовании
- **Освобождение слотов**: Кнопка для освобождения всех слотов вручную

### Управление при смене чата
- **Автоматическое сохранение**: При переключении на другой чат кеш всех персонажей автоматически сохраняется (если персонаж использовал слот минимум 1 раз)
- **Очистка слотов**: Автоматическая очистка всех слотов перед распределением персонажей нового чата
- **Распределение персонажей**: Автоматическое распределение персонажей нового чата по слотам

### Валидация и безопасность
- **Проверка размера файлов**: Автоматическая проверка размера сохраненных файлов (файлы меньше 1 МБ считаются невалидными и удаляются)
- **Обработка ошибок**: Корректная обработка ошибок с информативными сообщениями
- **Защита от потери данных**: Сохранение кеша перед вытеснением персонажей из слотов

## Настройки

### Включить автосохранение
- **Описание**: Включает/выключает автоматическое сохранение кеша
- **По умолчанию**: Включено
- **Рекомендации**: Рекомендуется оставить включенным для автоматического сохранения прогресса

### Сохранять каждые N сообщений
- **Описание**: Интервал автоматического сохранения кеша для каждого персонажа
- **По умолчанию**: 5 сообщений
- **Как работает**: Каждый персонаж имеет свой счетчик сообщений. Когда счетчик достигает указанного значения, кеш автоматически сохраняется и счетчик сбрасывается
- **Рекомендации**: 
  - Меньшие значения (3-5) - для частого сохранения, больше места на диске
  - Большие значения (10-20) - для редкого сохранения, экономия места

### Максимум файлов на персонажа
- **Описание**: Максимальное количество автосохранений для каждого персонажа в каждом чате
- **По умолчанию**: 10 файлов
- **Как работает**: При превышении лимита старые автосохранения автоматически удаляются (новые сохраняются)
- **Важно**: Ручные сохранения с тегами не учитываются в этом лимите и не удаляются
- **Рекомендации**: 
  - 5-10 файлов - для экономии места
  - 15-20 файлов - для большего количества точек восстановления

### Показывать уведомления
- **Описание**: Включает/выключает toast-уведомления о сохранении, загрузке и других операциях
- **По умолчанию**: Включено
- **Рекомендации**: Отключите, если уведомления мешают работе

### Очистка при смене чата
- **Описание**: Автоматически сохраняет кеш и очищает слоты при переключении на другой чат
- **По умолчанию**: Включено
- **Как работает**: 
  - При смене чата кеш всех персонажей сохраняется (если использовался минимум 1 раз)
  - Все слоты очищаются на сервере
  - Персонажи нового чата распределяются по слотам
- **Рекомендации**: 
  - Включено - для автоматического управления при работе с несколькими чатами
  - Выключено - если хотите вручную управлять переключением между чатами

### Таймаут предзагрузки (минуты)
- **Описание**: Максимальное время ожидания генерации кеша для каждого персонажа во время предзагрузки
- **По умолчанию**: 20 минут
- **Как работает**: 
  - При предзагрузке кеша для персонажей группового чата каждый персонаж имеет таймаут
  - Если генерация занимает больше времени, чем таймаут, она будет отменена и помечена как ошибка
  - Процесс продолжается со следующим персонажем
- **Рекомендации**: 
  - 10-15 минут - для быстрых моделей или меньших контекстов
  - 20-30 минут - для медленных моделей или больших контекстов
  - Увеличьте, если испытываете частые таймауты во время предзагрузки

## Формат файлов

Расширение использует единый формат имен файлов для всех типов сохранений:

### Автосохранения (без тега)
```
{chatId}_{timestamp}_character_{characterName}.bin
```

**Пример**: `chat1_20240115143022_character_Alice.bin`

### Ручные сохранения (с тегом)
```
{chatId}_{timestamp}_tag_{tag}_character_{characterName}.bin
```

**Пример**: `chat1_20240115143022_tag_важный_момент_character_Alice.bin`

### Структура имени файла
- **chatId**: Нормализованное имя чата (без специальных символов)
- **timestamp**: Временная метка в формате `YYYYMMDDHHmmss` (14 цифр)
- **tag**: Тег для ручного сохранения (опционально, только для ручных сохранений)
- **characterName**: Имя персонажа (используется для идентификации при загрузке)

### Важные особенности
- **Имена персонажей вместо слотов**: Файлы именуются по персонажам, а не по номерам слотов, что обеспечивает корректную загрузку даже при изменении порядка слотов
- **Нормализация имен**: Все имена (чата, персонажа, тега) нормализуются для безопасного использования в именах файлов
- **Обратная совместимость**: Поддерживается парсинг старых форматов файлов (с номерами слотов) для совместимости

### Валидация файлов
- Файлы размером меньше 1 МБ считаются невалидными и автоматически удаляются
- Проверка размера происходит после сохранения с небольшой задержкой (500 мс)

## Технические детали

### Управление слотами

Расширение использует систему слотов llama.cpp сервера для управления кешем нескольких персонажей одновременно.

**Алгоритм выделения слотов:**
1. Если персонаж уже в слоте - используется существующий слот
2. Если есть свободный слот - персонаж занимает его
3. Если свободных слотов нет - вытесняется персонаж с наименьшим счетчиком использования
4. Перед вытеснением кеш сохраняется (если использовался минимум 1 раз)

**Счетчик использования:**
- Увеличивается при каждой новой генерации ответа (`type === 'normal'`) или если счетчик равен 0
- Не увеличивается при свайпе или продолжении, если счетчик уже больше 0
- Сбрасывается в 0 при загрузке кеша
- Используется для определения наименее используемого слота при вытеснении

### Перехват генерации

Расширение использует механизм перехватчиков генерации SillyTavern для автоматической загрузки кеша перед генерацией ответа.

**Типы генерации:**
- `normal` - обычная генерация (увеличивает счетчик использования)
- `regenerate` - регенерация (увеличивает счетчик, если равен 0)
- `swipe` - свайп (не увеличивает счетчик, если больше 0)
- `continue` - продолжение (не увеличивает счетчик, если больше 0)
- `quiet` - тихая генерация (используется для предзагрузки, увеличивает счетчик, если равен 0)
- `impersonate` - генерация от имени пользователя (пропускается)

### События SillyTavern

Расширение подписывается на следующие события:
- `GENERATE_BEFORE_COMBINE_PROMPTS` - обновление списка слотов перед генерацией
- `TEXT_COMPLETION_SETTINGS_READY` - установка `id_slot` для генерации
- `MESSAGE_RECEIVED` - обработка сообщений для автосохранения
- `CHAT_CHANGED` - обработка смены чата

### Нормализация имен

Все имена (чата, персонажа, тега) нормализуются для безопасного использования:
- Удаление специальных символов
- Замена пробелов на подчеркивания
- Приведение к единому формату

Это обеспечивает корректную работу с файловой системой и предотвращает проблемы с кодировкой.

## Требования

- **SillyTavern**: Версия с поддержкой расширений и механизмом перехватчиков генерации
- **llama.cpp сервер**: 
  - Поддержка KV-кеша
  - API для работы со слотами (`/slots`, `/slot/load`, `/slot/save`, `/slot/clear`)
  - Поддержка параметра `id_slot` в запросах генерации
- **Серверный плагин**: [kv_cache-manager-plugin](https://github.com/fortrest-jr/kv_cache-manager-plugin)
  - Предоставляет API для получения списка файлов (`/api/files/list`)
  - Предоставляет API для удаления файлов (`/api/files/delete`)
  - Без установки плагина функция загрузки кеша будет недоступна

## Лицензия

MIT

